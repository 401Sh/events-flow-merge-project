# Our events backend - NestJS + TypeScript + Axios

## Цель проекта

Разработать бэкенд, который будет агрегировать и предоставлять данные о мероприятиях с двух независимых API: Leader-id и Timepad.

## Задачи

- [X] Получение списка мероприятий
- [X] Фильтрация мероприятий по городу пользователя
- [X] Определение города по координатам пользователя
- [X] Просмотр информации о мероприятии
- [ ] Вход по OAuth Timepad
- [X] Вход по OAuth Leader-ID
- [X] Список посещенных пользователем мероприятий
- [ ] Список мероприятий на которые записался пользователь

## Технологии

- **TypeScript** - статическая типизация для повышения надежности кода.
- **Class-Validator** - валидация клиентских запросов.
- **NestJS** - обработка маршрутов.
- **@NestJS/Axios** - формирование запросов к API.

## Установка

1. Клонируйте репозиторий

```bash
git clone https://gitverse.ru/studentlabs/our_events_backend
```

2. Перейдите в директорию проекта

```bash
cd our_events_backend
```

3. Устновите зависимости

```bash
npm install
```

## Запуск

Для запуска проекта потребуется создать файл .env в корне каталога и настроить его. Пример конфигурации - example.env файл.
В данный момент проект не может работать без предоставления токена доступа к API timepad и client_id с secret_id от API leader-id.
- Получить токен доступа timepad можно ссылке: https://dev.timepad.ru/api/oauth/
- Получить client_id и secret_id от leader-id можно по ссылке: https://leader-id.ru/en/developers

```bash
npm run start
```

После запуска проект будет доступен по адресу {HOST}:{PORT}/api/v1, а Swagger по адресу {HOST}:{PORT}/api/v1/docs

## Миграции БД

1. Создание миграции

```bash
# Автоматическая генерация схемы миграции с изменениями
npm run migration:generate

# Генерация шаблона миграции для ручного ввода изменений
npm run migration:create
```

2. Применение миграции

```bash
npm run migration:run
```

3. Отмена миграции

```bash
npm run migration:revert
```

Миграции доступны по пути /src/database/migrations/

## Структура проекта

```
src/
│
│── auth/               # Модули аунтентификации и авторизации
│   ├── client-auth/    # Модуль получения токенов доступа к API
│   ├── dto/
│   ├── interfaces/
│   ├── oauth/          # Модуль пользовательской аутентификации
│       ├── guards/
│       ├── services/   # Сервисы логики запросов данных со сторонних API
│
│── configs/
│── constants/
│
│── database/           # Вспомогательный функционал для БД (сиды и миграции)
│
│── dictionaries/       # Модуль словарей
│   ├── dto/
│   ├── entities/       # Сущности БД
│   ├── services/       # Сервисы логики запросов данных со сторонних API
│
│── events/             # Модуль мероприятий
│   ├── api-utils/      # Мапперы для приведения events к одному виду
│   ├── dto/
│   ├── enums/
│   ├── interfaces/
│   ├── services/       # Сервисы логики запросов данных со сторонних API
│
│── geo/                # Модуль городов и местоположения
│   ├── dto/
│   ├── entities/       # Сущности БД
│
│── users/              # Модуль пользователей
│   ├── api-utils/      # Мапперы для приведения данных к visited events
│   ├── dto/
│   ├── guards/
│   ├── services/       # Сервисы логики запросов данных со сторонних API
│
.env
tsconfig.json
package.json
```

## Используемые роуты

### Модуль dictionaries

- **GET    /dictionaries/themes**                    - Получение списка общих категорий/тем для фильтрации
- **GET    /dictionaries/themes/:source**            - Получение списка категорий/тем от источника

### Модуль events

- **GET    /events**                              - Получение общего списка событий от двух источников
- **GET    /events/:source**                      - Получение списка событий от источника
- **GET    /events/:source/:eventId**             - Получение данных о событии от источника (в данный момент работает только для timepad)

### Модуль geo

- **GET    /geo**                                 - Получение списка городов
- **GET    /geo/:cityId/nearest**                 - Получение списка ближайших городов к конкретному городу
- **GET    /geo/coords**                          - Получение id ближайшего города по координатам

### Модуль users

- **GET    /users/:userId/leaderId**                      - Получение данных пользователя
- **GET    /users/:userId/participations/leaderId**       - Получения посещенных пользователем мероприятий

### Модуль oauth

- **GET    /oauth/redirect/:source**                - Редирект на авторизацию в источнике
- **GET    /oauth/callback/leaderId**               - Обмен кода leaderId на токены доступа
- **POST   /oauth/refresh/leaderId**                - Обновление токенов доступа leaderId по refresh токену

## Статус проекта

Проект находится в разработке - активно ведётся разработка базового функционала и архитектуры.